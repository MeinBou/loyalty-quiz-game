<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loyalty Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0f172a, #1d1b48, #4c1d95);
        }
        .screen { display: none; }
        .screen.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
        }
        .character-card {
            background-color: rgba(255, 255, 255, 0.1);
            border: 2px solid transparent;
            border-radius: 10px;
            transition: transform 0.3s, box-shadow 0.3s;
            backdrop-filter: blur(5px);
        }
        .character-card:hover {
            transform: translateY(-8px) scale(1.05);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
        }
        .character-card.selected {
            border-color: #facc15;
            box-shadow: 0 0 15px #facc15;
            transform: scale(1.1);
        }
        .buzzer-btn, .statement-btn, .player-vote-card {
            position: relative;
            transition: all 0.2s ease-in-out;
        }
        .buzzer-btn:hover:not(:disabled), .statement-btn:hover:not(:disabled), .player-vote-card:hover:not(:disabled) {
            transform: scale(1.05);
            filter: brightness(1.2);
        }
        .answer-indicator {
            position: absolute;
            bottom: -10px;
            display: flex;
            width: 100%;
            justify-content: center;
            gap: 4px;
        }
        .answer-indicator img {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 0 5px black;
        }
        .contestant-pod .player-avatar-indicator {
            transition: all 0.3s;
            border: 3px solid transparent;
        }
        .contestant-pod.answered .player-avatar-indicator {
             border-color: #10B981;
             transform: scale(1.1);
        }
        .answer-option-label.correct { background-color: #10B981; }
        .answer-option-label.absurd { background-color: #EF4444; }
        
        .glass-panel {
            background: rgba(17, 24, 39, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .winner-card {
            animation: winner-reveal 1s ease-out forwards;
        }
        @keyframes winner-reveal {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .final-list-item {
            opacity: 0;
            animation: list-fade-in 0.5s ease-out forwards;
        }
        .rank-1 { background-color: #facc15; color: #1f2937; transform: scale(1.05); }
        .rank-2 { background-color: #d1d5db; color: #1f2937; }
        .rank-3 { background-color: #cd7f32; color: #1f2937; }
        .lie-marker {
            transition: transform 0.2s, filter 0.2s;
        }
        .lie-marker.selected {
            transform: scale(1.3);
            filter: drop-shadow(0 0 8px #facc15);
        }

        /* Lucky Seven Styles */
        .dice-pod {
            perspective: 1000px;
        }
        .dice {
            width: 80px;
            height: 80px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 1s;
        }
        .dice-face {
            position: absolute;
            width: 80px;
            height: 80px;
            border: 2px solid #fff;
            background: rgba(17, 24, 39, 0.8); /* More opaque */
            font-size: 40px;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .face-1 { transform: rotateY(0deg) translateZ(40px); }
        .face-2 { transform: rotateY(90deg) translateZ(40px); }
        .face-3 { transform: rotateY(180deg) translateZ(40px); }
        .face-4 { transform: rotateY(-90deg) translateZ(40px); }
        .face-5 { transform: rotateX(90deg) translateZ(40px); }
        .face-6 { transform: rotateX(-90deg) translateZ(40px); }
        .lucky-pod.success {
            box-shadow: 0 0 20px #22c55e;
            border-color: #22c55e;
        }
        .number-tracker {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            width: 100%;
            padding: 0 8px;
            margin-top: 8px;
        }
        .tracker-num {
            background-color: rgba(0,0,0,0.3);
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
            transition: background-color 0.3s, color 0.3s;
        }
        .tracker-num.found {
            background-color: #22c55e;
            color: #fff;
        }
    </style>
</head>
<body class="text-white flex items-center justify-center min-h-screen p-4">

    <!-- Audio Controls -->
    <div class="absolute top-4 right-4 glass-panel p-2 flex items-center space-x-2 z-10">
        <button id="mute-btn" class="w-8 h-8 flex items-center justify-center">
            <svg id="volume-icon" class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M7 4a1 1 0 00-2 0v12a1 1 0 102 0V4zM13 4a1 1 0 00-2 0v12a1 1 0 102 0V4z"/></svg>
        </button>
        <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="0.5" class="w-24">
    </div>

    <!-- Main Menu -->
    <div id="main-menu" class="screen active text-center">
        <h1 class="text-6xl font-bold mb-8 text-transparent bg-clip-text bg-gradient-to-r from-yellow-300 to-pink-500">Loyalty Quiz</h1>
        <div class="space-y-4 glass-panel p-8">
            <button id="create-room-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg w-64 text-lg transition shadow-lg hover:shadow-xl">Crea Stanza</button>
            <div class="flex items-center space-x-2">
                <input type="text" id="room-code-input" placeholder="Codice Stanza" class="bg-gray-800 border-gray-700 rounded-lg py-3 px-4 w-40 text-center">
                <button id="join-room-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-6 rounded-lg w-auto text-lg transition">Entra</button>
            </div>
        </div>
    </div>

    <!-- Game Mode Selection -->
    <div id="game-mode-selection" class="screen w-full max-w-md mx-auto">
        <div class="glass-panel p-8 space-y-4 w-full text-center">
            <h2 class="text-3xl font-bold mb-6 text-indigo-400">Scegli la ModalitÃ </h2>
            <button data-mode="quiz" class="game-mode-btn w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 px-6 rounded-lg text-xl transition">ðŸ§  Loyalty Quiz</button>
            <button data-mode="lies" class="game-mode-btn w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-4 px-6 rounded-lg text-xl transition">ðŸ¤¥ Bugie e VeritÃ </button>
            <button data-mode="lucky" class="game-mode-btn w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-4 px-6 rounded-lg text-xl transition">ðŸŽ² Sette Fortunato</button>
            <button data-mode="who-said-this" class="game-mode-btn w-full bg-rose-600 hover:bg-rose-700 text-white font-bold py-4 px-6 rounded-lg text-xl transition">ðŸ¥¸ Chi ha detto questo?</button>
        </div>
    </div>
    
    <!-- Game Mode Description -->
    <div id="game-mode-description" class="screen w-full max-w-lg mx-auto">
        <div class="glass-panel p-8 space-y-4 w-full text-center">
            <h2 id="description-title" class="text-3xl font-bold mb-4"></h2>
            <p id="description-text" class="text-lg min-h-[100px]"></p>
            <button id="continue-to-setup-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition">Continua</button>
        </div>
    </div>

    <!-- Game Setup -->
    <div id="game-setup" class="screen w-full max-w-md mx-auto">
        <div class="glass-panel p-8 space-y-4 w-full">
            <h2 class="text-3xl font-bold mb-6 text-center text-indigo-400">Impostazioni Partita</h2>
            <div>
                <label for="num-players" class="block mb-2 text-sm font-medium text-gray-300">Numero totale di giocatori (2-10)</label>
                <input type="number" id="num-players" min="2" max="10" value="4" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg w-full p-2.5">
            </div>
             <div>
                <label for="num-cpu" class="block mb-2 text-sm font-medium text-gray-300">Numero di CPU (min 0)</label>
                <input type="number" id="num-cpu" min="0" max="9" value="1" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg w-full p-2.5">
            </div>
             <div id="questions-per-judge-container">
                <label for="num-questions" class="block mb-2 text-sm font-medium text-gray-300">Domande per giudice</label>
                <input type="number" id="num-questions" min="1" max="10" value="2" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg w-full p-2.5">
            </div>
             <div id="rounds-per-person-container">
                <label for="num-rounds" class="block mb-2 text-sm font-medium text-gray-300">Round (frasi per persona)</label>
                <input type="number" id="num-rounds" min="1" max="4" value="1" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg w-full p-2.5">
            </div>
            <button id="start-game-setup-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition">Crea Stanza e Invita</button>
        </div>
    </div>
    
    <!-- Room Code Screen -->
    <div id="room-code-screen" class="screen w-full max-w-md mx-auto text-center">
        <div class="glass-panel p-8 w-full">
            <h2 class="text-3xl font-bold mb-4 text-indigo-400">Invita i tuoi Amici!</h2>
            <p class="mb-4">Condividi questo codice per farli unire alla partita:</p>
            <div class="bg-gray-900/50 p-4 rounded-lg flex items-center justify-between">
                <span id="room-code-display" class="text-3xl font-bold tracking-widest"></span>
                <button id="copy-code-btn" class="bg-gray-600 hover:bg-gray-700 py-2 px-4 rounded-lg">Copia</button>
            </div>
            <button id="continue-to-roster-btn" class="mt-8 w-full bg-green-600 hover:bg-green-700 font-bold py-3 rounded-lg text-lg transition">Avanti</button>
        </div>
    </div>

    <!-- Character Roster -->
    <div id="character-roster" class="screen w-full max-w-5xl mx-auto">
        <h2 class="text-4xl font-bold mb-8 text-center">Scegli il tuo Personaggio</h2>
        <div id="roster-grid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-6"></div>
        <div class="mt-8 text-center glass-panel p-4 flex items-center space-x-4">
             <input type="text" id="nickname-input" placeholder="Il tuo Nickname" class="bg-gray-800 border border-gray-700 rounded-lg py-3 px-4 w-64 text-center">
            <button id="confirm-character-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition disabled:opacity-50" disabled>Conferma</button>
        </div>
    </div>

    <!-- Lobby -->
    <div id="lobby" class="screen w-full max-w-2xl mx-auto text-center">
        <div class="glass-panel p-8 w-full">
            <h2 class="text-3xl font-bold mb-4 text-indigo-400">Sala d'Attesa</h2>
            <p class="mb-2">Codice Stanza: <strong id="lobby-room-code"></strong></p>
            <p class="mt-6 mb-4 text-xl">Giocatori (<span id="player-count">1</span>/<span id="max-players">10</span>):</p>
            <div id="player-list" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
            <button id="start-game-btn" class="mt-8 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg text-xl transition hidden">Inizia Partita</button>
        </div>
    </div>

    <!-- Quiz Screen -->
    <div id="quiz-screen" class="screen w-full max-w-7xl mx-auto h-full">
        <div class="flex flex-col md:flex-row gap-6 w-full h-full">
            <div class="flex-grow flex flex-col">
                <div id="judge-area" class="glass-panel p-6 text-center mb-6">
                     <div class="flex justify-between items-center mb-4">
                         <div class="text-lg">Domanda <span id="current-question-num">1</span>/<span id="total-questions-num">3</span></div>
                         <div class="flex flex-col items-center">
                             <img id="judge-avatar" src="" class="w-20 h-20 rounded-full border-4 border-indigo-400 object-cover">
                             <p class="mt-2 font-bold text-lg">Giudice: <span id="judge-name"></span></p>
                         </div>
                         <div id="timer" class="text-3xl font-bold bg-indigo-600 rounded-full w-20 h-20 flex items-center justify-center">30</div>
                     </div>
                    <p id="question-text" class="text-3xl font-semibold min-h-[7rem] flex items-center justify-center p-4"></p>
                </div>
                <div id="contestants-area" class="flex-grow grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>
            <div id="leaderboard-container" class="w-full md:w-1/3 lg:w-1/4 glass-panel p-4">
                 <h2 class="text-2xl font-bold mb-4 text-center text-indigo-400">Classifica</h2>
                 <div id="leaderboard-list" class="space-y-2"></div>
            </div>
        </div>
    </div>

    <!-- Statement Creation Screen (Bugie e VeritÃ ) -->
    <div id="statement-creation-screen" class="screen w-full max-w-2xl mx-auto">
        <div class="glass-panel p-8 w-full">
            <h2 class="text-3xl font-bold mb-2 text-center text-teal-400">Il tuo turno!</h2>
            <p class="text-center mb-6">Scrivi 2 veritÃ  e 1 bugia. Clicca ðŸ¤¥ accanto all'affermazione falsa.</p>
            <div id="statement-inputs-container" class="space-y-4">
                <div class="flex items-center space-x-4"><input type="text" class="statement-input flex-grow bg-gray-900/50 border border-gray-600 rounded-lg p-3" placeholder="Affermazione 1"><span class="lie-marker text-3xl cursor-pointer">ðŸ¤¥</span></div>
                <div class="flex items-center space-x-4"><input type="text" class="statement-input flex-grow bg-gray-900/50 border border-gray-600 rounded-lg p-3" placeholder="Affermazione 2"><span class="lie-marker text-3xl cursor-pointer">ðŸ¤¥</span></div>
                <div class="flex items-center space-x-4"><input type="text" class="statement-input flex-grow bg-gray-900/50 border border-gray-600 rounded-lg p-3" placeholder="Affermazione 3"><span class="lie-marker text-3xl cursor-pointer">ðŸ¤¥</span></div>
            </div>
            <button id="submit-statements-btn" class="w-full mt-6 bg-teal-600 hover:bg-teal-700 font-bold py-3 rounded-lg text-lg transition">Conferma</button>
        </div>
    </div>

    <!-- Voting Screen (Bugie e VeritÃ ) -->
    <div id="voting-screen" class="screen w-full max-w-3xl mx-auto">
         <div class="flex flex-col md:flex-row gap-6 w-full h-full">
            <div class="flex-grow flex flex-col glass-panel p-8 w-full text-center">
                <div class="flex flex-col items-center mb-6">
                    <img id="storyteller-avatar" src="" class="w-24 h-24 rounded-full border-4 border-teal-400 object-cover">
                    <p class="mt-2 font-bold text-xl">Qual Ã¨ la bugia di <span id="storyteller-name"></span>?</p>
                </div>
                <div id="statements-to-vote" class="space-y-4"></div>
            </div>
            <div id="lies-leaderboard-container" class="w-full md:w-1/3 lg:w-1/4 glass-panel p-4">
                 <h2 class="text-2xl font-bold mb-4 text-center text-teal-400">Classifica</h2>
                 <div id="lies-leaderboard-list" class="space-y-2"></div>
            </div>
        </div>
    </div>

    <!-- Lucky Seven Screen -->
    <div id="lucky-seven-screen" class="screen w-full max-w-7xl mx-auto h-full">
        <div class="flex flex-col md:flex-row gap-6 w-full h-full">
            <div id="lucky-seven-pods-area" class="flex-grow grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            <div id="lucky-leaderboard-container" class="w-full md:w-1/3 lg:w-1/4 glass-panel p-4">
                 <h2 class="text-2xl font-bold mb-4 text-center text-amber-400">Progresso</h2>
                 <div id="lucky-leaderboard-list" class="space-y-2"></div>
            </div>
        </div>
    </div>

    <!-- Who Said This - Submission Screen -->
    <div id="who-said-this-submission-screen" class="screen w-full max-w-2xl mx-auto">
        <div class="glass-panel p-8 w-full text-center">
            <h2 class="text-3xl font-bold mb-2 text-rose-400">Chi ha detto questo?</h2>
            <p class="mb-6">Scrivi le tue <span id="wst-submission-count">1</span> frasi anonime (max 10 parole l'una).</p>
            <div id="phrases-input-container" class="space-y-3"></div>
            <button id="submit-phrases-btn" class="w-full mt-4 bg-rose-600 hover:bg-rose-700 font-bold py-3 rounded-lg text-lg transition">Invia Frasi ðŸ¥¸</button>
        </div>
    </div>

    <!-- Who Said This - Voting Screen -->
    <div id="who-said-this-voting-screen" class="screen w-full max-w-7xl mx-auto h-full">
         <div class="flex flex-col md:flex-row gap-6 w-full h-full">
            <div class="flex-grow flex flex-col glass-panel p-8 w-full text-center">
                 <div class="flex justify-between items-center mb-6">
                     <div class="w-16"></div>
                     <h2 class="text-3xl font-bold text-rose-400">Chi ha detto questo?</h2>
                     <div id="wst-timer" class="text-2xl font-bold bg-rose-600 rounded-full w-16 h-16 flex items-center justify-center">30</div>
                 </div>
                <div class="bg-gray-900/50 p-6 rounded-lg mb-8">
                    <p id="phrase-to-guess" class="text-3xl font-semibold">"</p>
                </div>
                <div id="player-voting-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                    <!-- Player vote cards go here -->
                </div>
            </div>
            <div id="wst-leaderboard-container" class="w-full md:w-1/3 lg:w-1/4 glass-panel p-4">
                 <h2 class="text-2xl font-bold mb-4 text-center text-rose-400">Classifica</h2>
                 <div id="wst-leaderboard-list" class="space-y-2"></div>
            </div>
        </div>
    </div>


    <!-- Question Creation Screen (Quiz) -->
    <div id="question-creation-screen" class="screen w-full max-w-2xl mx-auto">
        <div class="w-full glass-panel p-8">
            <h2 class="text-3xl font-bold mb-6 text-center text-indigo-400">Crea le tue Domande</h2>
            <p class="text-center mb-4">Sei il giudice! Crea <span id="questions-to-create-count"></span> domande.</p>
            <div id="question-form-container"></div>
        </div>
    </div>
    
    <!-- Final Leaderboard Screen -->
    <div id="final-leaderboard-screen" class="screen w-full max-w-2xl mx-auto text-center">
        <div class="glass-panel p-8 w-full">
            <h2 id="winner-announcement" class="text-4xl font-bold mb-8 text-yellow-300 opacity-0">E il vincitore Ã¨...</h2>
            <div id="winner-card-container" class="mb-8"></div>
            <div id="final-leaderboard-list" class="space-y-3"></div>
            <div id="badge-container" class="mt-6 flex justify-center gap-4"></div>
            <button id="play-again-btn" class="mt-8 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg text-xl transition opacity-0">Torna al Menu</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // --- FIREBASE IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, onSnapshot, updateDoc, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- DOM ELEMENTS ---
        const screens = document.querySelectorAll('.screen');
        const createRoomBtn = document.getElementById('create-room-btn');
        const joinRoomBtn = document.getElementById('join-room-btn');
        const roomCodeInput = document.getElementById('room-code-input');
        const gameModeSelectionScreen = document.getElementById('game-mode-selection');
        const startGameSetupBtn = document.getElementById('start-game-setup-btn');
        const confirmCharacterBtn = document.getElementById('confirm-character-btn');
        const rosterGrid = document.getElementById('roster-grid');
        const nicknameInput = document.getElementById('nickname-input');
        const playerList = document.getElementById('player-list');
        const playerCount = document.getElementById('player-count');
        const maxPlayers = document.getElementById('max-players');
        const startGameBtn = document.getElementById('start-game-btn');
        const judgeAvatar = document.getElementById('judge-avatar');
        const judgeName = document.getElementById('judge-name');
        const questionText = document.getElementById('question-text');
        const contestantsArea = document.getElementById('contestants-area');
        const timerDisplay = document.getElementById('timer');
        const currentQuestionNum = document.getElementById('current-question-num');
        const totalQuestionsNum = document.getElementById('total-questions-num');
        const leaderboardList = document.getElementById('leaderboard-list');
        const questionFormContainer = document.getElementById('question-form-container');
        const questionsToCreateCount = document.getElementById('questions-to-create-count');
        const numPlayersInput = document.getElementById('num-players');
        const numCpuInput = document.getElementById('num-cpu');
        const numQuestionsInput = document.getElementById('num-questions');
        const numRoundsInput = document.getElementById('num-rounds');
        const muteBtn = document.getElementById('mute-btn');
        const volumeSlider = document.getElementById('volume-slider');
        const volumeIcon = document.getElementById('volume-icon');
        const finalLeaderboardScreen = document.getElementById('final-leaderboard-screen');
        const winnerAnnouncement = document.getElementById('winner-announcement');
        const winnerCardContainer = document.getElementById('winner-card-container');
        const finalLeaderboardList = document.getElementById('final-leaderboard-list');
        const playAgainBtn = document.getElementById('play-again-btn');
        const questionsPerJudgeContainer = document.getElementById('questions-per-judge-container');
        const roundsPerPersonContainer = document.getElementById('rounds-per-person-container');
        const statementCreationScreen = document.getElementById('statement-creation-screen');
        const submitStatementsBtn = document.getElementById('submit-statements-btn');
        const votingScreen = document.getElementById('voting-screen');
        const storytellerAvatar = document.getElementById('storyteller-avatar');
        const storytellerName = document.getElementById('storyteller-name');
        const statementsToVote = document.getElementById('statements-to-vote');
        const liesLeaderboardList = document.getElementById('lies-leaderboard-list');
        const luckySevenScreen = document.getElementById('lucky-seven-screen');
        const luckySevenPodsArea = document.getElementById('lucky-seven-pods-area');
        const luckyLeaderboardList = document.getElementById('lucky-leaderboard-list');
        const whoSaidThisSubmissionScreen = document.getElementById('who-said-this-submission-screen');
        const phrasesInputContainer = document.getElementById('phrases-input-container');
        const wstSubmissionCount = document.getElementById('wst-submission-count');
        const submitPhrasesBtn = document.getElementById('submit-phrases-btn');
        const whoSaidThisVotingScreen = document.getElementById('who-said-this-voting-screen');
        const wstTimer = document.getElementById('wst-timer');
        const phraseToGuess = document.getElementById('phrase-to-guess');
        const playerVotingGrid = document.getElementById('player-voting-grid');
        const wstLeaderboardList = document.getElementById('wst-leaderboard-list');
        const badgeContainer = document.getElementById('badge-container');
        const roomCodeDisplay = document.getElementById('room-code-display');
        const copyCodeBtn = document.getElementById('copy-code-btn');
        const continueToRosterBtn = document.getElementById('continue-to-roster-btn');
        const lobbyRoomCode = document.getElementById('lobby-room-code');
        const descriptionTitle = document.getElementById('description-title');
        const descriptionText = document.getElementById('description-text');
        const continueToSetupBtn = document.getElementById('continue-to-setup-btn');


        // --- FIREBASE & GAME STATE ---
        let db, auth;
        let userId, currentRoomId;
        let roomUnsubscribe = null; // To detach the Firestore listener
        
        let localGameState = {}; // Holds temporary local data
        let selectedCharacter = null;
        let timerInterval;
        let quizMusic, dingSound;
        let isGameStarting = false;

        // --- DATA ---
        const characters = [
            { name: "Ametista", img: "https://i.pinimg.com/736x/11/b5/05/11b5056b41f87fbe3120b68ed5dcfb09.jpg" }, { name: "Barbie", img: "https://i.pinimg.com/1200x/bd/e7/29/bde7296be641d72842be35b84065b48f.jpg" }, { name: "Bowser", img: "https://i.pinimg.com/1200x/cf/3f/ec/cf3fec1f6b9334e0255065f150fa97a9.jpg" }, { name: "Brago", img: "https://i.pinimg.com/1200x/7f/28/31/7f283141b761fee05de62cd51f4926ee.jpg" }, { name: "Carlos Oliveira", img: "https://i.pinimg.com/736x/9c/d7/61/9cd7611ff4aaceecd802b75a2d2ad1f6.jpg" }, { name: "Corvina", img: "https://i.pinimg.com/736x/fc/e3/30/fce330b50ce9cbf53287e441be15d597.jpg" }, { name: "Cosmo", img: "https://i.pinimg.com/736x/47/22/99/472299b4c669c052c662df1730403d83.jpg" }, { name: "Crash", img: "https://i.pinimg.com/736x/98/e7/25/98e7251ed569efffda255ab33c0ffb11.jpg" }, { name: "Daffy Duck", img: "https://i.pinimg.com/736x/be/a3/7e/bea37edf64883f0cebaa68S9c9fbad71.jpg" }, { name: "Darwin Watterson", img: "https://i.pinimg.com/736x/44/ad/5f/44ad5f25f6dae6e19757b15346684583.jpg" }, { name: "Doraemon", img: "https://i.pinimg.com/736x/b1/75/de/b175de80fb0f5ca9b5230f0b12f3c13c.jpg" }, { name: "Elsa", img: "https://i.pinimg.com/736x/fd/26/cd/fd26cd346c9e73430dc9ba28e318fb74.jpg" }, { name: "Ferb", img: "https://i.pinimg.com/736x/63/04/d3/6304d368076442119f65936ca107067c.jpg" }, { name: "Finn", img: "https://i.pinimg.com/736x/29/83/75/298375aacfcc94f3310fad5578000f6d.jpg" }, { name: "Francine Smith", img: "https://i.pinimg.com/736x/18/c1/d2/18c1d2489a64b1b4f9cc78318e62da94.jpg" }, { name: "Garnet", img: "https://i.pinimg.com/736x/65/9b/d2/659bd260c80c7ecb1e2c1d7c7c3e9508.jpg" }, { name: "Gumball", img: "https://i.pinimg.com/736x/af/61/0f/af610f55e819f4bd3f37e5001a2b19ee.jpg" }, { name: "Johnny Bravo", img: "https://i.pinimg.com/736x/b4/cd/95/b4cd959a9bb7efaf289ba3e4ae85d4b8.jpg" }, { name: "Katara", img: "https://i.pinimg.com/736x/00/14/5e/00145ebb0ae3ae4b2af824d831faf313.jpg" }, { name: "Kirby", img: "https://i.pinimg.com/736x/ba/e6/63/bae6637b3efecfd002f0c1f9605e53be.jpg" }, { name: "Ladybug", img: "https://i.pinimg.com/736x/72/32/f1/7232f16bdab9dd11a2fa77403a1fe9f1.jpg" }, { name: "Lara Croft", img: "https://i.pinimg.com/736x/44/b5/78/44b5784b5428b7ec98410ae142330966.jpg" }, { name: "Lapis", img: "https://i.pinimg.com/1200x/09/fb/12/09fb12467957da96/913fc8f75e6f6356.jpg" }, { name: "Leela", img: "https://i.pinimg.com/1200x/6e/c8/b6/6ec8b67dc6bb062afc2007495b041e84.jpg" }, { name: "Leon Kennedy", img: "https://i.pinimg.com/736x/0a/27/cd/0a27cd44aae181df0884d85bf18d0574.jpg" }, { name: "Link", img: "https://i.pinimg.com/736x/be/29/0a/be290ac4f5b6f1de6f88ee2099e04da1.jpg" }, { name: "Lisa Simpson", img: "https://i.pinimg.com/736x/bf/df/10/bfdf10aa4399efd5fc1430601b589613.jpg" }, { name: "Lola Bunny", img: "https://i.pinimg.com/1200x/ee/12/ad/ee12ad4d87c9f5e3bafb2e1bc9676439.jpg" }, { name: "Luigi", img: "https://i.pinimg.com/1200x/0b/49/30/0b49308522463829166e76b0d914c8b8.jpg" }, { name: "Marceline", img: "https://i.pinimg.com/736x/bb/93/5e/bb935e39f2d66248b6e4178227bdb233.jpg" }, { name: "Mario", img: "https://i.pinimg.com/736x/61/62/b5/6162b56bc61a4050bb34d7203e03642d.jpg" }, { name: "Mia", img: "https://i.pinimg.com/736x/f0/5b/f1/f05bf1f89011521e38e5729e6cb9596f.jpg" }, { name: "Ned Flanders", img: "https://pbs.twimg.com/media/Fenv8bnWIAIdub7.jpg:large" }, { name: "Nicole Watterson", img: "https://i.pinimg.com/736x/81/24/e4/8124e43da43e1d06dcdbca15f22a0cd9.jpg" }, { name: "Oggy", img: "https://i.pinimg.com/736x/ca/8a/de/ca8ade9acdf1115e9364fd30abd41754.jpg" }, { name: "Olaf", img: "https://i.pinimg.com/736x/a5/d4/2f/a5d42f86e89066cb61ebafe1f8a47fa7.jpg" }, { name: "Orso Bianco", img: "https://i.pinimg.com/736x/9c/36/59/9c3659e69419f16abe572e4241667bcd.jpg" }, { name: "Patrick Stella", img: "https://i.pinimg.com/1200x/27/e0/2e/27e02eadbe6a321a7d0a9641a394c811.jpg" }, { name: "Perla", img: "https://i.pinimg.com/736x/7b/2e/b7/7b2eb73a3f511efa5bc182d1db60191b.jpg" }, { name: "Perry l'Ornitorinco", img: "https://i.pinimg.com/736x/59/f2/98/59f29865a1e5fd69d69984b4a8d91729.jpg" }, { name: "Peter Griffin", img: "https://i.pinimg.com/736x/9e/40/74/9e4074bbe7890cd245b51b9ff5c0e33c.jpg" }, { name: "Pikachu", img: "https://i.pinimg.com/736x/ad/65/b6/ad65b669746561313925ffff392518bc.jpg" }, { name: "Po", img: "https://i.pinimg.com/1200x/fb/99/a5/fb99a5c7ce5b313ed1c4e71ee0260a9b.jpg" }, { name: "Ponygon", img: "https://i.pinimg.com/1200x/4a/ee/29/4aee29b5bc03c3f3dfbec858428e86a9.jpg" }, { name: "Princess Peach", img: "https://i.pinimg.com/1200x/d5/dc/9d/d5dc9dbe1fd202663b5338fc582cdc24.jpg" }, { name: "Roger", img: "https://i.pinimg.com/736x/f7/7a/f5/f77af51ffcf31ec171aedd80322811bc.jpg" }, { name: "Rosalinda", img: "https://i.pinimg.com/736x/09/14/f0/0914f029e712e92de9d4f0081a5da032.jpg" }, { name: "Roserade", img: "https://i.pinimg.com/1200x/67/88/49/678849c01d18a4e0b90038bc069642ce.jpg" }, { name: "Shinobu", img: "https://i.pinimg.com/736x/e4/61/5c/e4615cec0e441309da374106183f0b23.jpg" }, { name: "Son Goku", img: "https://i.pinimg.com/1200x/37/5c/2f/375c2fd286cdc41c06764f91f708a687.jpg" }, { name: "Ada Wong", img: "https://i.pinimg.com/736x/19/ca/67/19ca678bedd73e74380204b75852e476.jpg" }, { name: "Victoream", img: "https://cfm.yidio.com/images/tv/26379/646955/episode-image-400x225.jpg" }, { name: "Wario", img: "https://i.pinimg.com/736x/07/72/16/07721681614a459938a7f85ec450f957.jpg" }, { name: "Numero 39 Utopia", img: "https://i.pinimg.com/1200x/d2/75/fd/d275fd366eb62231ae06dc636395b7ae.jpg" }, { name: "Wanda", img: "https://i.pinimg.com/1200x/fd/b3/ba/fdb3bada328ff3eb5aff2cc8c5bc92d1.jpg" }, { name: "Zatch Bell", img: "https://i.pinimg.com/1200x/35/9c/9e/359c9e3e0530e20c95754847066e8167.jpg" }, { name: "Zuko", img: "https://i.pinimg.com/736x/f3/ac/60/f3ac60495d1922cc97723975473b7c8d.jpg" }, { name: "Spinel", img: "https://i.pinimg.com/736x/d2/78/b0/d278b0606af1be5a2fb8ebf69dfca045.jpg" }
        ];
        const MUSIC_TRACKS = [
            'https://www.myinstants.com/media/sounds/kahoot-lobby-music.mp3',
            'https://www.myinstants.com/media/sounds/wii-shop-channel.mp3',
            'https://www.myinstants.com/media/sounds/splatoon-2-ost-2-without-a-doubt.mp3'
        ];
        const GAME_DESCRIPTIONS = {
            quiz: {
                title: "ðŸ§  Loyalty Quiz",
                text: "A turno, un giocatore sarÃ  il Giudice e porrÃ  delle domande. Gli altri devono indovinare la risposta corretta! Il Giudice guadagna punti per ogni giocatore che indovina. Attenzione alla risposta 'assurda' che fa perdere punti!"
            },
            lies: {
                title: "ðŸ¤¥ Bugie e VeritÃ ",
                text: "A turno, un giocatore racconterÃ  due veritÃ  e una bugia. Gli altri devono votare per scoprire qual Ã¨ la bugia. Chi indovina guadagna punti. Se il narratore inganna tutti, guadagna un bonus!"
            },
            lucky: {
                title: "ðŸŽ² Sette Fortunato",
                text: "Una gara di pura fortuna! Ogni giocatore lancia un dado a 7 facce. L'obiettivo Ã¨ ottenere tutti i numeri da 1 a 7. Il primo che completa la serie vince la partita!"
            },
            'who-said-this': {
                title: "ðŸ¥¸ Chi ha detto questo?",
                text: "Tutti scrivono delle frasi anonime. Poi, una frase alla volta viene rivelata e tutti devono indovinare chi l'ha scritta. Guadagni punti se indovini l'autore e anche quando gli altri indovinano che sei tu l'autore!"
            }
        };
        const CPU_QUESTION_BANK = [
            { text: "Quale animale dorme fino a 22 ore al giorno?", answers: ["Gatto", "Koala", "Bradipo", "Leone"], correct: 1, absurd: 3 },
            { text: "Qual Ã¨ l'unico mammifero in grado di volare?", answers: ["Scoiattolo volante", "Pipistrello", "Galeopiteco", "Uccello"], correct: 1, absurd: 3 },
            { text: "Di che colore Ã¨ la lingua di una giraffa?", answers: ["Rosa", "Rossa", "Nera-bluastra", "Verde"], correct: 2, absurd: 3 },
            { text: "Quanti cuori ha un polpo?", answers: ["Uno", "Due", "Tre", "Otto"], correct: 2, absurd: 3 },
            { text: "Quale pianeta Ã¨ conosciuto come il 'Pianeta Rosso'?", answers: ["Marte", "Venere", "Giove", "Saturno"], correct: 0, absurd: 1 },
            { text: "Qual Ã¨ il paese piÃ¹ piccolo del mondo?", answers: ["Monaco", "Nauru", "CittÃ  del Vaticano", "San Marino"], correct: 2, absurd: 1 },
            { text: "Chi ha dipinto la 'Notte Stellata'?", answers: ["Monet", "Picasso", "Van Gogh", "Da Vinci"], correct: 2, absurd: 0 },
            { text: "Qual Ã¨ l'oceano piÃ¹ grande del mondo?", answers: ["Atlantico", "Indiano", "Artico", "Pacifico"], correct: 3, absurd: 2 },
            { text: "In che anno Ã¨ affondato il Titanic?", answers: ["1905", "1912", "1918", "1923"], correct: 1, absurd: 3 },
            { text: "Quale gas le piante assorbono dall'atmosfera?", answers: ["Ossigeno", "Azoto", "Anidride Carbonica", "Idrogeno"], correct: 2, absurd: 0 },
            { text: "Chi ha scritto 'Amleto'?", answers: ["Dickens", "Shakespeare", "Austen", "Twain"], correct: 1, absurd: 0 },
            { text: "Qual Ã¨ la capitale dell'Australia?", answers: ["Sydney", "Melbourne", "Canberra", "Perth"], correct: 2, absurd: 0 },
            { text: "Quale metallo Ã¨ liquido a temperatura ambiente?", answers: ["Oro", "Mercurio", "Rame", "Argento"], correct: 1, absurd: 0 },
            { text: "Quante ossa ha uno squalo?", answers: ["206", "Circa 100", "Zero", "PiÃ¹ di 500"], correct: 2, absurd: 3 },
            { text: "Quale personaggio dei cartoni vive in un ananas sotto il mare?", answers: ["Nemo", "SpongeBob", "Patrick", "Squiddi"], correct: 1, absurd: 3 },
            { text: "Qual Ã¨ l'ingrediente principale del guacamole?", answers: ["Pomodoro", "Cipolla", "Avocado", "Peperone"], correct: 2, absurd: 3 },
            { text: "Quale azienda tecnologica ha come logo una mela morsicata?", answers: ["Microsoft", "Samsung", "Google", "Apple"], correct: 3, absurd: 1 },
            { text: "Quale supereroe Ã¨ conosciuto come l'Uomo d'Acciaio?", answers: ["Batman", "Superman", "Iron Man", "Hulk"], correct: 1, absurd: 2 },
            { text: "Quale strumento musicale ha 88 tasti?", answers: ["Chitarra", "Violino", "Pianoforte", "Flauto"], correct: 2, absurd: 0 },
            { text: "In quale cittÃ  si trova la Torre Eiffel?", answers: ["Roma", "Londra", "Berlino", "Parigi"], correct: 3, absurd: 0 },
            { text: "Quale film ha come protagonisti Woody e Buzz Lightyear?", answers: ["Shrek", "Toy Story", "Madagascar", "L'era glaciale"], correct: 1, absurd: 0 },
            { text: "Qual Ã¨ la bevanda piÃ¹ consumata al mondo dopo l'acqua?", answers: ["CaffÃ¨", "TÃ¨", "Succo d'arancia", "Birra"], correct: 1, absurd: 2 },
            { text: "Quale dei seguenti non Ã¨ un colore primario?", answers: ["Rosso", "Verde", "Giallo", "Blu"], correct: 1, absurd: 3 },
            { text: "Quanti lati ha un esagono?", answers: ["5", "6", "7", "8"], correct: 1, absurd: 3 },
            { text: "Chi Ã¨ il re della giungla?", answers: ["Tigre", "Orso", "Elefante", "Leone"], correct: 3, absurd: 1 },
            { text: "Quale pianeta ha gli anelli piÃ¹ famosi?", answers: ["Giove", "Saturno", "Urano", "Nettuno"], correct: 1, absurd: 0 },
            { text: "Come si chiama la paura dei ragni?", answers: ["Agorafobia", "Claustrofobia", "Aracnofobia", "Idrofobia"], correct: 2, absurd: 3 },
            { text: "Quale paese ha la forma di uno stivale?", answers: ["Grecia", "Spagna", "Italia", "Portogallo"], correct: 2, absurd: 0 },
            { text: "Cosa colleziona un filatelico?", answers: ["Monete", "Francobolli", "Libri", "Farfalle"], correct: 1, absurd: 3 },
            { text: "Quale organo umano produce la bile?", answers: ["Stomaco", "Fegato", "Rene", "Pancreas"], correct: 1, absurd: 2 },
            { text: "Se potessi avere un superpotere, quale sceglieresti?", answers: ["InvisibilitÃ ", "Volo", "Telepatia", "Super forza"], correct: 1, absurd: 3 },
            { text: "Qual Ã¨ la tua stagione preferita?", answers: ["Primavera", "Estate", "Autunno", "Inverno"], correct: 2, absurd: 0 },
            { text: "Cosa preferisci per colazione?", answers: ["CaffÃ¨ e cornetto", "Latte e cereali", "Yogurt e frutta", "Pancake"], correct: 0, absurd: 3 },
            { text: "Quale genere di film preferisci?", answers: ["Commedia", "Azione", "Fantascienza", "Horror"], correct: 2, absurd: 3 },
            { text: "Se vincessi alla lotteria, la prima cosa che faresti sarebbe:", answers: ["Comprare una casa", "Viaggiare", "Donare in beneficenza", "Licenziarmi"], correct: 1, absurd: 3 },
            { text: "Preferiresti vivere al mare o in montagna?", answers: ["Mare", "Montagna", "Entrambi", "Nessuno dei due"], correct: 0, absurd: 3 },
            { text: "Qual Ã¨ il tuo animale domestico ideale?", answers: ["Cane", "Gatto", "Pesce rosso", "Serpente"], correct: 0, absurd: 3 },
            { text: "Cosa fai per rilassarti?", answers: ["Leggere un libro", "Guardare una serie TV", "Ascoltare musica", "Fare sport"], correct: 2, absurd: 3 },
            { text: "Quale social media usi di piÃ¹?", answers: ["Instagram", "TikTok", "Facebook", "X (Twitter)"], correct: 0, absurd: 2 },
            { text: "Se potessi cenare con un personaggio storico, chi sceglieresti?", answers: ["Leonardo da Vinci", "Cleopatra", "Albert Einstein", "Napoleone"], correct: 0, absurd: 3 },
            { text: "Qual Ã¨ la tua pizza preferita?", answers: ["Margherita", "Diavola", "Quattro formaggi", "Capricciosa"], correct: 0, absurd: 2 },
            { text: "Preferisci il dolce o il salato?", answers: ["Dolce", "Salato", "Entrambi", "Dipende"], correct: 1, absurd: 0 },
            { text: "Quale vacanza da sogno vorresti fare?", answers: ["Safari in Africa", "Tour del Giappone", "Relax alle Maldive", "Avventura in PerÃ¹"], correct: 1, absurd: 0 },
            { text: "Cosa non puÃ² mancare nella tua borsa/zaino?", answers: ["Cellulare", "Portafoglio", "Chiavi", "Snack"], correct: 0, absurd: 3 },
            { text: "Sei una persona mattiniera o notturna?", answers: ["Mattiniera", "Notturna", "Nessuna delle due", "Dipende dai giorni"], correct: 1, absurd: 2 },
            { text: "Quale potere di un personaggio di fantasia vorresti avere?", answers: ["La Forza (Star Wars)", "Lanciare incantesimi", "La super velocitÃ ", "Rigenerazione"], correct: 0, absurd: 2 },
            { text: "Qual Ã¨ il tuo comfort food?", answers: ["Pizza", "Gelato", "Cioccolata", "Patatine fritte"], correct: 0, absurd: 1 },
            { text: "Cosa guardi per primo in una persona?", answers: ["Gli occhi", "Il sorriso", "Le mani", "Le scarpe"], correct: 1, absurd: 3 },
            { text: "Se la tua vita fosse un film, quale sarebbe il titolo?", answers: ["Una serie di sfortunati eventi", "La ricerca della felicitÃ ", "Mission: Impossible", "Molto rumore per nulla"], correct: 1, absurd: 0 },
            { text: "Quale talento nascosto vorresti avere?", answers: ["Saper cantare", "Saper disegnare", "Parlare tutte le lingue", "Essere un mago in cucina"], correct: 2, absurd: 0 }
        ];
        const CPU_STATEMENT_BANK = {
            "Default": [
                { truths: ["Una volta ho nuotato con i delfini.", "So suonare la chitarra."], lie: "Ho scalato il Monte Everest." },
                { truths: ["Parlo fluentemente tre lingue.", "Ho un gatto nero di nome Salem."], lie: "Ho vinto una gara di mangiatori di pizza." }
            ],
            "Mario": [
                { truths: ["Salto sui nemici per sconfiggerli.", "Amo la pasta."], lie: "Il mio migliore amico Ã¨ Sonic." },
                { truths: ["Sono un idraulico.", "Ho un fratello di nome Luigi."], lie: "Odio i funghi." }
            ],
            "Bowser": [
                { truths: ["Ho un esercito di Koopa.", "Respiro fuoco."], lie: "Sono segretamente innamorato di Luigi." },
                { truths: ["Ho otto figli.", "Spesso rapisco la Principessa Peach."], lie: "Mi piace fare giardinaggio nel tempo libero." }
            ],
            "Pikachu": [
                { truths: ["Il mio allenatore si chiama Ash.", "Posso generare elettricitÃ  dalle guance."], lie: "Odio le bacche." },
                { truths: ["La mia evoluzione Ã¨ Raichu.", "Comunico dicendo 'Pika Pika'."], lie: "Ho paura dei tuoni." }
            ],
            "Son Goku": [
                { truths: ["Posso trasformarmi in Super Saiyan.", "Il mio piÃ¹ grande rivale Ã¨ Vegeta."], lie: "La mia mossa preferita Ã¨ il Rasengan." },
                { truths: ["Sono cresciuto con mio nonno Gohan.", "Amo mangiare a dismisura."], lie: "Ho paura degli aghi." }
            ],
            "Crash": [
                { truths: ["Amo le mele Wumpa.", "Spesso combatto contro il Dr. Neo Cortex."], lie: "Sono un pilota di kart molto prudente." },
                { truths: ["Ho una sorella di nome Coco.", "La mia mossa speciale Ã¨ una giravolta."], lie: "Sono un grande lettore di romanzi classici." }
            ],
            "Lara Croft": [
                { truths: ["Esploro tombe antiche.", "Uso due pistole."], lie: "Ho paura dei ragni." },
                { truths: ["Sono un'archeologa britannica.", "Sono molto abile nella ginnastica."], lie: "Colleziono francobolli rari." }
            ]
        };
        const CPU_PHRASE_BANK = [
            "La pizza con l'ananas Ã¨ la mia preferita.", "Amo alzarmi presto la mattina per fare jogging.", "Non ho mai visto un film di Star Wars.", "Colleziono tappi di bottiglia rari.", "Il mio sogno Ã¨ diventare un astronauta.", "So parlare al contrario fluentemente.", "Una volta ho vinto una gara di mangiatori di hot dog.", "Credo negli unicorni.", "Il mio colore preferito Ã¨ il beige.", "Ascolto solo musica classica quando mi alleno.", "Non mi piace il cioccolato.", "Ho un serpente domestico di nome Briciola.", "So risolvere il cubo di Rubik in 30 secondi.", "Preferisco l'inverno all'estate.", "Non ho mai bevuto caffÃ¨ in vita mia.", "Il mio film preferito Ã¨ un documentario sui lombrichi.", "So fare giocoleria con le torce infuocate.", "Ho paura dei gattini.", "Una volta ho corso una maratona all'indietro.", "Il mio cibo preferito sono i cavoletti di Bruxelles.", "Posso leccarmi il gomito.", "Ho visitato tutti i continenti.", "Il mio supereroe preferito Ã¨ Aquaman.", "Non uso mai i social media.", "Preferisco leggere il dizionario che un romanzo.", "Ho costruito un robot nel mio garage.", "Il mio hobby Ã¨ l'apicoltura urbana.", "Non sopporto il suono delle onde del mare.", "Mangio la pizza partendo dalla crosta.", "Il mio animale spirituale Ã¨ il bradipo."
        ];


        // --- UTILITY FUNCTIONS ---
        const showScreen = (screenId) => {
            screens.forEach(screen => screen.classList.toggle('active', screen.id === screenId));
        };
        
        // --- FIREBASE SETUP ---
        const setupFirebase = async () => {
             try {
                // La tua configurazione personale di Firebase Ã¨ inserita qui.
                const firebaseConfig = {
                  apiKey: "AIzaSyCuvYQ9nuQU0qxYP3KsDAX646q23oDrN1Y",
                  authDomain: "loyalty-quiz-game.firebaseapp.com",
                  projectId: "loyalty-quiz-game",
                  storageBucket: "loyalty-quiz-game.firebasestorage.app",
                  messagingSenderId: "599988864606",
                  appId: "1:599988864606:web:2026754fb8724b9965d6cf",
                  measurementId: "G-4MH0MS4VWY"
                };

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, user => {
                    if (user) {
                        userId = user.uid;
                        console.log("Authenticated with user ID:", userId);
                    } else {
                        console.log("User is signed out.");
                        userId = null;
                        if (roomUnsubscribe) roomUnsubscribe();
                        showScreen('main-menu');
                    }
                });

                await signInAnonymously(auth);

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                alert("Impossibile connettersi ai server di gioco. Controlla la tua connessione e assicurati che i cookie di terze parti non siano bloccati. Ricarica la pagina per riprovare.");
            }
        };

        // --- CORE LOGIC ---
        const init = () => {
            // Call setupFirebase, but don't wait for it. Let it run in the background.
            setupFirebase(); 
            
            setupAudio();
            
            // Attach listeners immediately so the page is responsive.
            createRoomBtn.addEventListener('click', () => showScreen('game-mode-selection'));
            joinRoomBtn.addEventListener('click', handleJoinRoom);
            
            document.querySelectorAll('.game-mode-btn').forEach(btn => btn.addEventListener('click', (e) => {
                localGameState.gameMode = e.target.dataset.mode;
                const desc = GAME_DESCRIPTIONS[localGameState.gameMode];
                descriptionTitle.textContent = desc.title;
                descriptionText.textContent = desc.text;
                showScreen('game-mode-description');
            }));
            
            continueToSetupBtn.addEventListener('click', () => {
                questionsPerJudgeContainer.style.display = localGameState.gameMode === 'quiz' ? 'block' : 'none';
                roundsPerPersonContainer.style.display = localGameState.gameMode === 'who-said-this' ? 'block' : 'none';
                showScreen('game-setup');
            });

            startGameSetupBtn.addEventListener('click', handleCreateRoom);
            continueToRosterBtn.addEventListener('click', () => showScreen('character-roster'));
            copyCodeBtn.addEventListener('click', () => {
                const textArea = document.createElement("textarea");
                textArea.value = currentRoomId;
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    alert("Codice copiato!");
                } catch (err) {
                    console.error('Fallback: Oops, unable to copy', err);
                    alert("Impossibile copiare il codice. Selezionalo e copialo manualmente.");
                }
                document.body.removeChild(textArea);
            });
            
            confirmCharacterBtn.addEventListener('click', handleConfirmCharacter);
            startGameBtn.addEventListener('click', () => {
                updateRoom({ 
                    status: 'playing',
                    currentTurnIndex: -1,
                    roundsPlayed: 0
                });
            });
            playAgainBtn.addEventListener('click', () => window.location.reload());
            submitStatementsBtn.addEventListener('click', handleSubmitStatements);
            submitPhrasesBtn.addEventListener('click', handleSubmitPhrases);
            
            populateCharacterRoster();
        };
        
        // --- NEW ONLINE FUNCTIONS ---
        
        const handleCreateRoom = async () => {
            if (!userId) return alert("Autenticazione fallita. Riprova.");

            const totalPlayers = parseInt(numPlayersInput.value);
            const cpuCount = parseInt(numCpuInput.value);
            if (cpuCount >= totalPlayers) {
                alert("Il numero di CPU deve essere inferiore al numero totale di giocatori.");
                return;
            }

            const roomConfig = {
                totalPlayers,
                cpuPlayers: cpuCount,
                questionsPerJudge: parseInt(numQuestionsInput.value),
                roundsPerPerson: parseInt(numRoundsInput.value)
            };

            try {
                let players = {};
                let usedCharacters = [];
                
                for (let i = 0; i < cpuCount; i++) {
                    const cpuId = `cpu_${i}_${Date.now()}`;
                    let randomChar;
                    do {
                        randomChar = characters[Math.floor(Math.random() * characters.length)];
                    } while (usedCharacters.includes(randomChar.name));
                    usedCharacters.push(randomChar.name);
                    
                    players[cpuId] = {
                        uid: cpuId,
                        nickname: randomChar.name,
                        character: randomChar,
                        score: 0,
                        isCpu: true,
                        timesGuessed: 0
                    };
                }

                const roomData = {
                    hostId: userId,
                    config: roomConfig,
                    gameMode: localGameState.gameMode,
                    players: players,
                    status: 'lobby',
                    createdAt: new Date().toISOString()
                };
                
                const roomsCollection = collection(db, 'rooms');
                const docRef = await addDoc(roomsCollection, roomData);
                currentRoomId = docRef.id;
                
                roomCodeDisplay.textContent = currentRoomId;
                showScreen('room-code-screen');

            } catch (error) {
                console.error("Error creating room: ", error);
                alert("Impossibile creare la stanza. Riprova.");
            }
        };

        const handleJoinRoom = async () => {
            const code = roomCodeInput.value.trim();
            if (!code) return alert("Inserisci un codice stanza.");
            if (!userId) return alert("Autenticazione fallita. Riprova.");

            try {
                const roomRef = doc(db, 'rooms', code);
                const roomSnap = await getDoc(roomRef);

                if (roomSnap.exists()) {
                    const roomData = roomSnap.data();
                    const humanPlayers = Object.values(roomData.players).filter(p => !p.isCpu).length;
                    if (humanPlayers >= (roomData.config.totalPlayers - roomData.config.cpuPlayers)) {
                        return alert("Questa stanza Ã¨ piena di giocatori umani.");
                    }
                    currentRoomId = code;
                    showScreen('character-roster');
                } else {
                    alert("Stanza non trovata. Controlla il codice.");
                }
            } catch (error) {
                console.error("Error joining room:", error);
                alert("Errore durante l'accesso alla stanza.");
            }
        };

        const handleConfirmCharacter = async () => {
            const nickname = nicknameInput.value.trim();
            if (!selectedCharacter || !nickname) {
                return alert("Per favore, scegli un personaggio e inserisci un nickname.");
            }
            if (!currentRoomId) return;

            const playerData = {
                uid: userId,
                nickname,
                character: selectedCharacter,
                score: 0,
                isCpu: false,
                timesGuessed: 0
            };

            try {
                const roomRef = doc(db, 'rooms', currentRoomId);
                await updateDoc(roomRef, {
                    [`players.${userId}`]: playerData
                });
                joinLobby();
            } catch (error) {
                console.error("Error confirming character:", error);
            }
        };

        const joinLobby = () => {
            if (!currentRoomId) return;
            const roomRef = doc(db, 'rooms', currentRoomId);

            if (roomUnsubscribe) roomUnsubscribe();

            roomUnsubscribe = onSnapshot(roomRef, (doc) => {
                if (doc.exists()) {
                    const roomData = doc.data();
                    updateUI(roomData);
                } else {
                    if (roomUnsubscribe) roomUnsubscribe();
                    alert("La stanza non esiste piÃ¹.");
                    window.location.reload();
                }
            }, (error) => {
                console.error("Error listening to room:", error);
                alert("Connessione alla stanza persa.");
                window.location.reload();
            });
        };
        
        const updateUI = (roomData) => {
            console.log("Current Status:", roomData.status);
            
            if (roomData.status === 'lobby') {
                showScreen('lobby');
                lobbyRoomCode.textContent = currentRoomId;
                const totalPlayersInLobby = Object.keys(roomData.players).length;
                playerCount.textContent = totalPlayersInLobby;
                maxPlayers.textContent = roomData.config.totalPlayers;
                playerList.innerHTML = '';
                for (const uid in roomData.players) {
                    const player = roomData.players[uid];
                    const playerLabel = uid === roomData.hostId 
                        ? '<span class="text-xs text-indigo-400">Host</span>' 
                        : player.isCpu ? '<span class="text-xs text-gray-400">(CPU)</span>' : '';
                    playerList.innerHTML += `<div class="glass-panel p-3 text-center"><img src="${player.character.img}" class="w-16 h-16 rounded-full mx-auto mb-2 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/64x64/4B5563/E5E7EB?text=?';"><p class="font-semibold truncate">${player.nickname}</p>${playerLabel}</div>`;
                }
                
                if (userId === roomData.hostId) {
                    const humanPlayersCount = Object.values(roomData.players).filter(p => !p.isCpu).length;
                    const requiredHumanPlayers = roomData.config.totalPlayers - roomData.config.cpuPlayers;
                    if (humanPlayersCount >= requiredHumanPlayers) {
                       startGameBtn.classList.remove('hidden');
                    } else {
                       startGameBtn.classList.add('hidden');
                    }
                }
            } else if (roomData.status === 'playing' && !isGameStarting) {
                isGameStarting = true; // Prevent this from running multiple times
                quizMusic.play();
                renderGameScreen(roomData);
            } else if (roomData.status === 'playing') {
                renderGameScreen(roomData);
            }
        };

        const updateRoom = async (data) => {
            if (!currentRoomId) return;
            try {
                const roomRef = doc(db, 'rooms', currentRoomId);
                await updateDoc(roomRef, data);
            } catch (error) {
                console.error("Error updating room:", error);
            }
        };

        // --- REFACTORED GAME LOGIC ---
        const renderGameScreen = (roomData) => {
            console.log(`Rendering for game mode: ${roomData.gameMode}`);
            // This is the new central function to decide what to show
            switch(roomData.gameMode) {
                case 'quiz':
                    // We will build this logic out
                    showScreen('quiz-screen'); // Placeholder
                    break;
                case 'lies':
                    // We will build this logic out
                    showScreen('statement-creation-screen'); // Placeholder
                    break;
                case 'lucky':
                    // We will build this logic out
                    showScreen('lucky-seven-screen'); // Placeholder
                    break;
                case 'who-said-this':
                     // We will build this logic out
                    showScreen('who-said-this-submission-screen'); // Placeholder
                    break;
            }
        };

        const startNewRound = (roomData) => {
            if (userId !== roomData.hostId) return;

            if (roomData.roundsPlayed >= Object.keys(roomData.players).length) {
                updateRoom({ status: 'finished' });
                return;
            }
            const newTurnIndex = (roomData.currentTurnIndex + 1) % Object.keys(roomData.players).length;
            
            updateRoom({ 
                currentTurnIndex: newTurnIndex,
                // Reset round-specific data here in the future
            });
        };

        // --- OLD LOGIC (PLACEHOLDERS) ---
        const setupAudio = () => {
            const randomTrack = MUSIC_TRACKS[Math.floor(Math.random() * MUSIC_TRACKS.length)];
            quizMusic = new Howl({ src: [randomTrack], loop: true, volume: 0.5 });
            dingSound = new Howl({ src: ['https://www.myinstants.com/media/sounds/correct-answer-sound-effect.mp3'], volume: 0.7 });
            volumeSlider.addEventListener('input', (e) => Howler.volume(e.target.value));
            muteBtn.addEventListener('click', () => {
                const isMuted = Howler.volume() === 0;
                Howler.volume(isMuted ? volumeSlider.value : 0);
                volumeIcon.innerHTML = isMuted ? `<path d="M7 4a1 1 0 00-2 0v12a1 1 0 102 0V4zM13 4a1 1 0 00-2 0v12a1 1 0 102 0V4z"/>` : `<path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM12.293 7.293a1 1 0 011.414 0L15 8.586l1.293-1.293a1 1 0 111.414 1.414L16.414 10l1.293 1.293a1 1 0 01-1.414 1.414L15 11.414l-1.293 1.293a1 1 0 01-1.414-1.414L13.586 10l-1.293-1.293a1 1 0 010-1.414z" clip-rule="evenodd"/>`;
            });
        };

        const populateCharacterRoster = () => {
            rosterGrid.innerHTML = '';
            characters.forEach(char => {
                const card = document.createElement('div');
                card.className = 'character-card p-2 cursor-pointer';
                card.innerHTML = `<img src="${char.img}" alt="${char.name}" class="w-full h-24 object-cover rounded-md" onerror="this.onerror=null;this.src='https://placehold.co/100x100/374151/E5E7EB?text=?';"><p class="text-center text-xs mt-2 font-semibold truncate">${char.name}</p>`;
                card.addEventListener('click', () => {
                    document.querySelectorAll('.character-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    selectedCharacter = char;
                    confirmCharacterBtn.disabled = false;
                });
                rosterGrid.appendChild(card);
            });
        };
        
        const showQuestionCreationScreen = () => { /* To be refactored */ };
        const renderQuestionForm = () => { /* To be refactored */ };
        const saveQuestion = () => { /* To be refactored */ };
        const startQuizRound = () => { /* To be refactored */ };
        const startLiesRound = () => { /* To be refactored */ };
        const setupStatementCreationScreen = () => { /* To be refactored */ };
        const handleSubmitStatements = () => { /* To be refactored */ };
        const showVotingScreen = () => { /* To be refactored */ };
        const handleVote = () => { /* To be refactored */ };
        const simulateCpuVotes = () => { /* To be refactored */ };
        const checkAllVoted = () => { /* To be refactored */ };
        const showLiesResult = () => { /* To be refactored */ };
        const startQuizPhase = () => { /* To be refactored */ };
        const displayCurrentQuestion = () => { /* To be refactored */ };
        const handlePlayerAnswer = () => { /* To be refactored */ };
        const simulateCpuAnswers = () => { /* To be refactored */ };
        const checkAllAnswered = () => { /* To be refactored */ };
        const updateLeaderboardUI = () => { /* To be refactored */ };
        const startTimer = () => { /* To be refactored */ };
        const endQuestion = () => { /* To be refactored */ };
        const startLuckySevenGame = () => { /* To be refactored */ };
        const handlePlayerRoll = () => { /* To be refactored */ };
        const simulateCpuRolls = () => { /* To be refactored */ };
        const rollDice = () => { /* To be refactored */ };
        const processRoll = () => { /* To be refactored */ };
        const updateLuckySevenLeaderboard = () => { /* To be refactored */ };
        const startWhoSaidThisGame = () => { /* To be refactored */ };
        const startWSTSubmissionPhase = () => { /* To be refactored */ };
        const handleSubmitPhrases = () => { /* To be refactored */ };
        const startWhoSaidThisVotingPhase = () => { /* To be refactored */ };
        const showNextPhraseToGuess = () => { /* To be refactored */ };
        const handleWhoSaidThisVote = () => { /* To be refactored */ };
        const simulateWSTCpuVotes = () => { /* To be refactored */ };
        const checkAllWSTVoted = () => { /* To be refactored */ };
        const showWhoSaidThisResult = () => { /* To be refactored */ };
        const endGame = () => { /* To be refactored */ };
        
        // --- INIT ---
        init();
    </script>
</body>
</html>
